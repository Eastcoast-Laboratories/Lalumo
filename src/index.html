<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Lalumo</title>
  <link rel="icon" type="image/svg+xml" href="./favicon.svg" />
  <!-- Scripts and styles will be injected by webpack -->
</head>
<body>

  <main x-data="app()" x-init="init()" @click="initAudio()" class="container">
    
    <!-- Username Prompt Modal -->
    <div class="modal-overlay" x-show="showUsernamePrompt" x-transition>
      <div class="modal-content" @click.outside="setUsername()">
        <h3>Welcome to Lalumo!</h3>
        <div class="mascot-welcome">
          <img src="/images/mascot.png" alt="Lalumo Mascot" class="mascot" />
          <p>Let's create a special name just for you!</p>
        </div>
        <button class="primary-button" @click="setUsername()">Generate Random Name</button>
        <div class="modal-footer">
          <p class="note">Your progress will be saved automatically</p>
        </div>
      </div>
    </div>

    <!-- Hamburger Menu -->
    <div class="hamburger-container" :class="{ 'menu-open': menuOpen, 'desktop-menu': window.innerWidth >= 1024, 'menu-locked': menuLocked }" x-init="window.innerWidth >= 1024 ? menuOpen = true : menuOpen = false; window.addEventListener('resize', () => { if(window.innerWidth >= 1024) menuOpen = true; })">
      <!-- Hamburger button with conditional click handler based on lock state -->
      <button class="hamburger-button" @click="menuLocked ? null : menuOpen = !menuOpen">
        <div class="hamburger-icon">
          <span></span>
          <span></span>
          <span></span>
        </div>
      </button>
      
      <!-- Child Lock button with progress indicator -->
      <button class="menu-lock-button" 
        :class="{ 'locked': menuLocked }"
        @mousedown="startLongPressUnlock" 
        @mouseup="cancelLongPressUnlock" 
        @mouseleave="cancelLongPressUnlock"
        @touchstart="startLongPressUnlock" 
        @touchend="cancelLongPressUnlock" 
        @touchcancel="cancelLongPressUnlock">
        <div class="lock-icon-container">
          <div class="lock-progress-indicator" x-show="menuLocked"></div>
          <div class="lock-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 1C8.676 1 6 3.676 6 7v2H4v14h16V9h-2V7c0-3.324-2.676-6-6-6zm0 2c2.276 0 4 1.724 4 4v2H8V7c0-2.276 1.724-4 4-4zm0 10c1.1 0 2 .9 2 2s-.9 2-2 2-2-.9-2-2 .9-2 2-2z" x-show="menuLocked"/>
              <path d="M12 1C8.676 1 6 3.676 6 7v2h4V7c0-1.104.896-2 2-2s2 .896 2 2v2h4V7c0-3.324-2.676-6-6-6zm0 20c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm6-9H6v8h12v-8z" x-show="!menuLocked"/>
            </svg>
          </div>
        </div>
        <span class="lock-hint" x-show="menuLocked">Halte 3 Sek. gedr√ºckt zum Entsperren</span>
      </button>
      
      <!-- Menu content -->
      <div class="menu-content" x-show="menuOpen" @click.away="window.innerWidth < 1024 ? menuOpen = false : null" x-transition>
        
        <!-- Chapters Section -->
        <div class="menu-chapters">
          <button @click="$data.active = 'pitches'; $dispatch('set-pitch-mode', 'main'); window.innerWidth < 1024 ? menuOpen = false : null" :class="{ 'active': active === 'pitches' }">Pitches & Melodies</button>
          <button @click="$data.active = 'tonecolors'; window.innerWidth < 1024 ? menuOpen = false : null" :class="{ 'active': active === 'tonecolors' }" style="display: none;">Tone Colors</button>
          <button @click="$data.active = 'rhythms'; window.innerWidth < 1024 ? menuOpen = false : null" :class="{ 'active': active === 'rhythms' }" style="display: none;">Rhythm</button>
          <button @click="$data.active = 'chords'; window.innerWidth < 1024 ? menuOpen = false : null" :class="{ 'active': active === 'chords' }" style="display: none;">Chords</button>
          <button @click="$data.active = 'freeplay'; window.innerWidth < 1024 ? menuOpen = false : null" :class="{ 'active': active === 'freeplay' }" style="display: none;">Free Play</button>
        </div>
        
        <!-- Activities Section (shows only when Pitches chapter is active) -->
        <template x-if="active === 'pitches'">
          <div class="menu-activities">
            <button 
              @click="$dispatch('set-pitch-mode', 'listen'); window.innerWidth < 1024 ? menuOpen = false : null"
              x-data="{ isActive: false }"
              x-init="$watch('$store.pitchMode', value => isActive = value === 'listen')"
              :class="{ 'active': isActive }"
            >Listen to Melodies</button>
            <button 
              @click="$dispatch('set-pitch-mode', 'match'); window.innerWidth < 1024 ? menuOpen = false : null"
              x-data="{ isActive: false }"
              x-init="$watch('$store.pitchMode', value => isActive = value === 'match')"
              :class="{ 'active': isActive }"
            >Match Sounds</button>
            <button 
              @click="$dispatch('set-pitch-mode', 'draw'); window.innerWidth < 1024 ? menuOpen = false : null"
              x-data="{ isActive: false }"
              x-init="$watch('$store.pitchMode', value => isActive = value === 'draw')"
              :class="{ 'active': isActive }"
            >Draw a Melody</button>
            <button 
              @click="$dispatch('set-pitch-mode', 'guess'); window.innerWidth < 1024 ? menuOpen = false : null"
              x-data="{ isActive: false }"
              x-init="$watch('$store.pitchMode', value => isActive = value === 'guess')"
              :class="{ 'active': isActive }"
            >Guess Next Note</button>
            <button 
              @click="$dispatch('set-pitch-mode', 'memory'); window.innerWidth < 1024 ? menuOpen = false : null"
              x-data="{ isActive: false }"
              x-init="$watch('$store.pitchMode', value => isActive = value === 'memory')"
              :class="{ 'active': isActive }"
            >Memory Game</button>
          </div>
        </template>
        
        <!-- Flexible spacer to push settings and legal to bottom -->
        <div class="menu-spacer"></div>
        
        <!-- Settings Section -->
        <div class="menu-settings">
          
          <button @click="$data.active = 'settings'; window.innerWidth < 1024 ? menuOpen = false : null" :class="{ 'active': active === 'settings' }" class="settings-button" x-show="username">
            <div class="user-avatar" x-show="username">
              <span x-text="username ? username.charAt(0) : '?'"></span>
            </div>
            <span class="settings-label">Player Settings</span>
          </button>
        </div>
        
        <!-- Legal Section -->
        <div class="menu-legal">
          <button @click="$data.active = 'impressum'; window.innerWidth < 1024 ? menuOpen = false : null" :class="{ 'active': active === 'impressum' }">
            <span>Impressum</span>
          </button>
          <button @click="$data.active = 'datenschutz'; window.innerWidth < 1024 ? menuOpen = false : null" :class="{ 'active': active === 'datenschutz' }">
            <span>Datenschutz</span>
          </button>
          <button @click="$data.active = 'credits'; window.innerWidth < 1024 ? menuOpen = false : null" :class="{ 'active': active === 'credits' }">
            <span>Credits</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Chapter: Pitch Chapters View -->
    <section x-show="active === 'pitches'" x-transition class="pitch-chapters-view" style="background-image: url('./images/backgrounds/pitches5.png'); background-size: cover; background-position: top center; border-radius: 0;">
      <div x-data="pitches()" x-init="init()">
        
        <!-- Main landing with clickable image -->
        <div x-show="!mode || mode === 'main'" class="pitch-landing">
          <div class="image-map-container">
            <div class="clickable-area listen-area" @click="setMode('listen')" aria-label="Listen Mode">
              <span class="area-label">Listen to Melodies</span>
            </div>
            <div class="clickable-area match-area" @click="setMode('match')" aria-label="Match Mode">
              <span class="area-label">Match Sounds</span>
            </div>
            <div class="clickable-area guess-area" @click="setMode('guess')" aria-label="Guess Mode">
              <span class="area-label">Guess Next Note</span>
            </div>
            <div class="clickable-area memory-area" @click="setMode('memory')" aria-label="Memory Mode">
              <span class="area-label">Memory Game</span>
            </div>
            <div class="clickable-area draw-area" @click="setMode('draw')" aria-label="Draw Mode">
              <span class="area-label">Draw a Melody</span>
            </div>
          </div>

        </div>
        
        <!-- Listening Mode -->
        <div x-show="mode === 'listen'" class="pitch-activity">
          <div class="mode-header">
            <h3>Listen to different melodies!</h3>
            <button class="back-to-main" @click="setMode('main')" aria-label="Back to main menu">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24" height="24">
                <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
              </svg>
              <span>Back to Menu</span>
            </button>
          </div>
          
          <div class="pitch-grid">
            <div class="pitch-card" :class="{ 'active': currentAnimation === 'up' }" @click="playSequence('up')" 
                 @mousedown="$event => startLongPress('up', $event)" @mouseup="cancelLongPress()" @mouseleave="cancelLongPress()"
                 @touchstart="$event => startLongPress('up', $event)" @touchend="cancelLongPress()" @touchcancel="cancelLongPress()">
              <div class="pitch-icon up">
                <img src="/images/rocket.png" alt="Rocket going up" />
              </div>
            </div>
            
            <div class="pitch-card" :class="{ 'active': currentAnimation === 'down' }" @click="playSequence('down')" 
                 @mousedown="$event => startLongPress('down', $event)" @mouseup="cancelLongPress()" @mouseleave="cancelLongPress()"
                 @touchstart="$event => startLongPress('down', $event)" @touchend="cancelLongPress()" @touchcancel="cancelLongPress()">
              <div class="pitch-icon down">
                <img src="/images/slide.png" alt="Slide going down" />
              </div>
            </div>
            
            <div class="pitch-card" :class="{ 'active': currentAnimation === 'wave' }" @click="playSequence('wave')" 
                 @mousedown="$event => startLongPress('wave', $event)" @mouseup="cancelLongPress()" @mouseleave="cancelLongPress()"
                 @touchstart="$event => startLongPress('wave', $event)" @touchend="cancelLongPress()" @touchcancel="cancelLongPress()">
              <div class="pitch-icon wave">
                <img src="/images/waves.png" alt="Wave pattern" />
              </div>
            </div>
            
            <div class="pitch-card" :class="{ 'active': currentAnimation === 'jump' }" @click="playSequence('jump')" 
                 @mousedown="$event => startLongPress('jump', $event)" @mouseup="cancelLongPress()" @mouseleave="cancelLongPress()"
                 @touchstart="$event => startLongPress('jump', $event)" @touchend="cancelLongPress()" @touchcancel="cancelLongPress()">
              <div class="pitch-icon jump">
                <img src="/images/frog.png" alt="Jumping frog" />
              </div>
            </div>
          </div>
        </div>
        
        <!-- Matching Mode -->
        <div x-show="mode === 'match'" class="pitch-activity">
          <div class="mode-header">
            <h3>Match the sound to the picture!</h3>
            <button class="back-to-main" @click="setMode('main')" aria-label="Back to main menu">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24" height="24">
                <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
              </svg>
              <span>Back to Menu</span>
            </button>
          </div>
          <button class="circular-play-button" @click="playCurrentMelody()" aria-label="Play Melody">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
              <path d="M8 5v14l11-7z"/>
            </svg>
          </button>
          
          <div class="pitch-grid">
            <div class="pitch-card" @click="checkMatch('up')" @mousedown="startLongPress('up')" @mouseup="cancelLongPress()" @mouseleave="cancelLongPress()">
              <div class="pitch-icon up">
                <img src="/images/rocket.png" alt="Rocket going up" />
              </div>
            </div>
            
            <div class="pitch-card" @click="checkMatch('down')" @mousedown="startLongPress('down')" @mouseup="cancelLongPress()" @mouseleave="cancelLongPress()">
              <div class="pitch-icon down">
                <img src="/images/slide.png" alt="Slide going down" />
              </div>
            </div>
            
            <div class="pitch-card" @click="checkMatch('wave')" @mousedown="startLongPress('wave')" @mouseup="cancelLongPress()" @mouseleave="cancelLongPress()">
              <div class="pitch-icon wave">
                <img src="/images/waves.png" alt="Wave pattern" />
              </div>
            </div>
            
            <div class="pitch-card" @click="checkMatch('jump')" @mousedown="startLongPress('jump')" @mouseup="cancelLongPress()" @mouseleave="cancelLongPress()">
              <div class="pitch-icon jump">
                <img src="/images/frog.png" alt="Jumping frog" />
              </div>
            </div>
          </div>
          
          <div x-show="showFeedback" class="feedback-message" x-text="feedback"></div>
        </div>
        
        <!-- Drawing Mode -->
        <div x-show="mode === 'draw'" class="pitch-activity">
          <div class="mode-header">
            <h3>Draw a melody!</h3>
            <button class="back-to-main" @click="setMode('main')" aria-label="Back to main menu">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24" height="24">
                <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
              </svg>
              <span>Back to Menu</span>
            </button>
          </div>
          
          <div class="drawing-container">
            <canvas class="drawing-canvas" width="400" height="200"
                   @mousedown="startDrawing" 
                   @mousemove="draw" 
                   @mouseup="endDrawing"
                   @touchstart="startDrawing" 
                   @touchmove="draw" 
                   @touchend="endDrawing">
            </canvas>
            
          </div>
          
          <button class="clear-button" @click="drawPath = []; setupDrawingMode()">Clear & Try Again</button>
        </div>
        
        <!-- Guessing Mode -->
        <div x-show="mode === 'guess'" class="pitch-activity">
          <div class="mode-header">
            <h3>What comes next?</h3>
            <button class="back-to-main" @click="setMode('main')" aria-label="Back to main menu">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24" height="24">
                <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
              </svg>
              <span>Back to Menu</span>
            </button>
          </div>
          <button class="circular-play-button" @click="playCurrentMelody()" aria-label="Play Melody">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
              <path d="M8 5v14l11-7z"/>
            </svg>
          </button>

          
          <div class="guess-options">
            <button class="guess-button up" @click="checkGuess('up')" data-direction="up">
              <span>Up</span> ‚¨ÜÔ∏è
            </button>
            <button class="guess-button down" @click="checkGuess('down')" data-direction="down">
              <span>Down</span> ‚¨áÔ∏è
            </button>
          </div>
          
          <div x-show="showFeedback" class="feedback-message" x-text="feedback"></div>
        </div>
        
        <!-- Memory Mode -->
        <div x-show="mode === 'memory'" class="pitch-activity">
          <div class="mode-header">
            <h3>Remember the melody!</h3>
            <button class="back-to-main" @click="setMode('main')" aria-label="Back to main menu">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24" height="24">
                <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
              </svg>
              <span>Back to Menu</span>
            </button>
          </div>
          <button class="circular-play-button" @click="playCurrentMelody()" aria-label="Play Melody">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
              <path d="M8 5v14l11-7z"/>
            </svg>
          </button>

          
          <div class="piano-keyboard">
            <!-- White keys C, D, E, G, A with black key indicators -->
            <button class="piano-key white c4" @click="addToSequence('C4')" :class="{ 'active': currentHighlightedNote === 'C4' }">C</button>
            <div class="piano-key black" aria-hidden="true"></div>
            <button class="piano-key white d4" @click="addToSequence('D4')" :class="{ 'active': currentHighlightedNote === 'D4' }">D</button>
            <div class="piano-key black" aria-hidden="true"></div>
            <button class="piano-key white e4" @click="addToSequence('E4')" :class="{ 'active': currentHighlightedNote === 'E4' }">E</button>
            <div class="piano-key inactive f4" aria-hidden="true">F</div>
            <div class="piano-key black" aria-hidden="true"></div>
            <button class="piano-key white g4" @click="addToSequence('G4')" :class="{ 'active': currentHighlightedNote === 'G4' }">G</button>
            <div class="piano-key black" aria-hidden="true"></div>
            <button class="piano-key white a4" @click="addToSequence('A4')" :class="{ 'active': currentHighlightedNote === 'A4' }">A</button>
            <div class="piano-key black" aria-hidden="true"></div>
            <div class="piano-key inactive b4" aria-hidden="true">H</div>
          </div>
          
          <div class="sequence-progress">
            <template x-for="(_, index) in userSequence" :key="index">
              <div class="progress-dot active"></div>
            </template>
            
            <template x-for="(_, index) in Array(Math.max(0, currentSequence.length - userSequence.length))" :key="index">
              <div class="progress-dot"></div>
            </template>
          </div>
          
          <div x-show="showFeedback" class="feedback-message" x-text="feedback"></div>
        </div>
      </div>
    </section>

    <!-- Chapter: Tone Colors -->
    <section x-show="active === 'tonecolors'" x-transition>
      <div x-data="tonecolors" x-init="init()">
        <h2>Discover Tone Colors</h2>
        <div class="tone-grid">
          <div class="tone-card" @click="pick('warm')">
            <div class="tone-icon warm"></div>
            <p>Warm</p>
          </div>
          <div class="tone-card" @click="pick('cold')">
            <div class="tone-icon cold"></div>
            <p>Cold</p>
          </div>
        </div>
      </div>
    </section>
    
    <!-- Chapter: Rhythm -->
    <section x-show="active === 'rhythms'" x-transition>
      <h2>Rhythm Exercises</h2>
      <p>Coming soon!</p>
    </section>
    
    <!-- Chapter: Chords -->
    <section x-show="active === 'chords'" x-transition>
      <h2>Chord Exploration</h2>
      <p>Coming soon!</p>
    </section>
    
    <!-- Chapter: Free Play -->
    <section x-show="active === 'freeplay'" x-transition>
      <h2>Free Play Mode</h2>
      <p>Coming soon!</p>
    </section>
    
    <!-- Legal: Impressum -->
    <section x-show="active === 'impressum' && (window.innerWidth >= 1024 || !menuOpen)" x-transition>
      <h2>Impressum</h2>
      <div class="legal-content">
        <p>Lalumo App - Musik lernen f√ºr Kinder</p>
        <p>Verantwortlich f√ºr den Inhalt:</p>
        <p>Ruben Barkow-Kuder<br>
        Knickweg 16
        24114 Kiel<br>
        <a href="mailto:lalumo-support@it.z11.de">lalumo-support@it.z11.de</a></p>
      </div>
    </section>
    
    <!-- Legal: Datenschutz -->
    <section x-show="active === 'datenschutz' && (window.innerWidth >= 1024 || !menuOpen)" x-transition>
      <h2>Datenschutz</h2>
      <div class="legal-content">
        <p>Datenschutzerkl√§rung f√ºr die Lalumo App</p>
        <p>Wir nehmen den Schutz Ihrer pers√∂nlichen Daten sehr ernst. Alle Daten werden lokal auf Ihrem Ger√§t gespeichert und nicht an Server √ºbertragen.</p>
        <h3>Lokale Speicherung</h3>
        <p>Die App speichert Folgendes lokal auf Ihrem Ger√§t:</p>
        <ul>
          <li>Benutzername</li>
          <li>Lernfortschritte</li>
        </ul>
      </div>
    </section>
    
    <!-- Legal: Credits -->
    <section x-show="active === 'credits' && (window.innerWidth >= 1024 || !menuOpen)" x-transition>
      <h2>Credits</h2>
      <div class="legal-content">
        <h3>App-Entwicklung</h3>
        <p>Lalumo Team</p>
        
        <h3>Grafiken & Illustrationen</h3>
        <p>SVG-Grafiken von [Quelle]</p>
        
        <h3>Technologien</h3>
        <ul>
          <li>Alpine.js</li>
          <li>Web Audio API</li>
          <li>HTML5 & CSS3</li>
        </ul>
      </div>
    </section>
    
    <!-- Settings Page -->
    <section x-show="active === 'settings' && (window.innerWidth >= 1024 || !menuOpen)" x-transition class="settings-page">
      <h2>Player Settings</h2>
      <div x-show="username" class="settings-section">
        <h3>Your Profile</h3>
        <div class="profile-section">
          <div class="profile-avatar">
            <span x-text="username ? username.charAt(0) : '?'"></span>
          </div>
          <div class="profile-details">
            <p class="profile-name" x-text="username"></p>
            <div class="username-edit">
              <input type="text" x-model="editableUsername" class="username-input" placeholder="Enter your name" maxlength="20">
              <button class="secondary-button" @click="saveUsername()">Save Name</button>
            </div>
            <button class="secondary-button" @click="setUsername()">Generate Random Name</button>
          </div>
        </div>
        
        <h3>Language Preference</h3>
        <div class="language-section">
          <p>Select your preferred language:</p>
          <div class="language-options">
            <button class="language-button" :class="{ 'active': preferredLanguage === 'english' }" @click="setLanguage('english')">English</button>
            <button class="language-button" :class="{ 'active': preferredLanguage === 'german' }" @click="setLanguage('german')">Deutsch</button>
          </div>
        </div>
        
        <h3>Game Progress</h3>
        <div class="progress-section">
          <p>Export your progress to save or transfer to another device:</p>
          <button class="primary-button" @click="exportProgress()">Export Progress</button>
          <div x-show="exportedData" class="export-data">
            <p>Copy this code to save your progress:</p>
            <textarea x-text="exportedData" readonly class="export-textarea"></textarea>
            <button class="secondary-button" @click="copyToClipboard()">Copy to Clipboard</button>
          </div>
          
          <p class="import-label">Import your progress from another device:</p>
          <textarea placeholder="Paste your progress data here..." x-model="importData" class="import-textarea"></textarea>
          <button class="primary-button" @click="importProgress()">Import Progress</button>
          
          <div class="reset-section">
            <h3>Reset Progress</h3>
            <p>Reset all your game progress and start fresh:</p>
            <div class="reset-buttons">
              <button class="warning-button" @click="showResetConfirm = true" x-show="!showResetConfirm">Reset All Progress</button>
              <div class="confirm-reset" x-show="showResetConfirm">
                <p>Are you sure? This cannot be undone.</p>
                <button class="danger-button" @click="resetProgress()">Yes, Reset Everything</button>
                <button class="secondary-button" @click="showResetConfirm = false">Cancel</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

</body>
</html>
