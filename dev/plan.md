# Musici File Structure Alignment Plan

## Notes
- User identified /src/effects/feedback.js as being in the wrong place.
- Reference canonical structure in dev/FILESTRUCTURE.md, shared utilities should live under `src/components/shared/`.
- The directory `src/components/shared/` has been created to house shared utilities.
- `feedback.js` relocated to `src/components/shared/`.
- Manual review revealed and fixed one import referencing the old path.
- Must also look for any other JS files that violate the documented structure and relocate them.
- After relocating, all import paths across the codebase must be updated.
- Update dev/FILESTRUCTURE.md to match the new, real structure.
- Adhere to user global rules: no fallback code, no unnecessary deployment, add diagnostics if needed.
- User confirmed file structure is correct; focus shifts to enhancing Chord Chapter user experience.
- User requested to review Chord code first and keep 2_x abbreviations in function names.
- Main Chords entry file is `src/components/chords.js`; sub-modules `2_*` will be migrated later.
- Rainbow feedback integrated into `chords.js` across all chord activities.
- Runtime error `checkColorAnswer is not defined` observed in `chords.js`; must fix.
- `checkColorAnswer` now imported into chords.js, error resolved.
- Tone.js audio and richer landscapes integrated into 2_2 mood landscapes.
- Play-full-chord button implemented in 2_3 chord-building.
- Audio-engine singleton (`src/components/audio-engine.js`) now powers all chord sounds; initAudio simply ensures `audioEngine.initialize()` is called upon first user gesture.
- User reports no sound in 2_1 and 2_2, and missing/unresponsive Play Full Chord button in 2_3; suspect off-screen buttons—set containers to 100% viewport height and debug Tone.js initialization / Transport start.
- Initial fixes committed: forced Tone.start() in initAudio, added full-height CSS for activity containers, and improved Play Full Chord button container lookup; awaiting user verification.
- `setupFullHeightContainers` function has been implemented to enforce 100vh containers and style rules.
- Replaced require usage in setupFullHeightContainers to avoid bundler issues; enhanced Tone.js auto-start logic and fixed Play Full Chord button positioning.
- User requested moving injected CSS rules into external stylesheet `src/styles/2_chords.css` and setting `.chord-chapters-view` height to 800px.
- Created external stylesheet `src/styles/2_chords.css` including chord activity styles and `.chord-chapters-view` height rule.
- Stylesheet now imported in `chords.js`, and inline CSS injection removed from `setupFullHeightContainers`.
- Injected existing `audioEngine` & Tone import into **2_1_chord_color_matching**, **2_2_chords_mood-landscapes**, **2_4_chords_missing-note**, and **2_6_harmmony_garden** to enable sound; awaiting verification.
- `2_6_harmmony_garden.js` module has been created and initial audio imports added.
- User explicitly said not to add a new audio engine; must reuse existing AudioEngine implementation already powering other chapters.
- User identified duplicate functions (e.g., `newColorMatchingQuestion`, `checkColorAnswer`) existing both in `chords.js` and `2_x` module files; wants duplicates removed and logic housed only in the respective `2_chords/*` files.
- `chords.js` should act as orchestrator/importer; all activity-specific logic must live inside `src/components/2_chords/` modules.
- Need a visible "Play Chord" button in **2_1 color-matching** activity.
- Clean up duplicate code introduced in commit `236a1f3` and ensure single source of truth per function.
- addPlayChordButton function implemented and invoked via dynamic import in **2_1_chord_color_matching.js**; Play button should now appear.
- Duplicate color-matching functions removed from `chords.js`; wrappers now dynamically import the module.
- addPlayChordButton now auto-initializes on module load; Play button confirmed in UI.
- Migrated `getMoodLandscapes` to **2_2_chord_mood_landscapes.js** and added dynamic wrapper in `chords.js` (duplicate removed).
- Migrated `updateLandscape` to **2_2_chord_mood_landscapes.js**; wrapper replacement in `chords.js` is now complete.
- Build succeeded after deduplication; user requests similar refactor process for other modules following FILESTRUCTURE.md lines 180-196.
- Bug: `currentChordType` undefined in index.html Play Chord button; need to set/handle variable.
- Note: addPlayChordButton task broken down into subtasks:
  - Implement addPlayChordButton function in **2_1_chord_color_matching.js**.
  - Ensure addPlayChordButton is invoked when activity loads.
  - Verify Play Chord button is visible and clickable.
- Fixed: Fallback approach eliminated; `currentChordType` is now initialized on activity load, ensuring it's always defined before button use.
- After fallback removal, the UI still logs "Unknown chord type: null"—need to trace where `currentChordType` becomes `null` before `playChord` is invoked.
- Redundant audioEngine initialization blocks were stripped; a single, reliable `initAudio` call in `chords.js` now guarantees the engine is ready. Remaining step: verify it fires before any chord playback.
- Identified multiple `currentChordType = null` resets in `chords.js` that may trigger "Unknown chord type: null"; need lifecycle audit.
- [x] Centralize audioEngine initialization in `chords.js` (`initAudio`) and remove scattered checks.
- Removed fallback logic from `playChord`; now logs error and exits when `chordType` is null or unknown, complying with no-fallback rule.
- Unnecessary `currentChordType = null` resets removed in `resetActivity` and post-chord `setTimeout`; lifecycle audit confirms no further null resets remain.
- [x] Optionally add assertion/logging in `playChord` when `chordType` is null to aid debugging.
- `audioEngine` import corrected to use default export; build warning resolved.
- [x] Fix incorrect `audioEngine` import in `chords.js` (use default export).
- `addPlayChordButton` updated to bind existing `.play-chord-button` in index.html and add logging; build ran successfully.
- No `npm start` script exists; use `npm run watch` for dev server when needed.
- Selector mismatch discovered: index.html uses `.play-button`, but `addPlayChordButton` looks for `.play-chord-button`; click handler never attaches.
- Selector mismatch fixed: `addPlayChordButton` now targets `.play-button` within the 2_1 activity container; click handler attaches and logs correctly.
- Local `getRandomRootNote` helper added in 2_1 module; no longer relies on `component.getRandomRootNote`.
- Local `getRandomChordType` helper added in 2_1 module and `newColorMatchingQuestion` updated to use local helpers; runtime error resolved.
- Build succeeds and Play button logs now appear, but `playChord` is still invoked with `null/undefined` chordType, triggering error; need to ensure `newColorMatchingQuestion` sets `currentChordType` before first playback and that it isn't cleared prematurely.
- Runtime error: `component.getRandomChordType` is not a function when generating a new question in 2_1 module.
- User identified duplicate functions (e.g., `newColorMatchingQuestion`, `checkColorAnswer`) existing both in `chords.js` and `2_x` module files; wants duplicates removed and logic housed only in the respective `2_chords/*` files.
- `chords.js` should act as orchestrator/importer; all activity-specific logic must live inside `src/components/2_chords/` modules.
- Need a visible "Play Chord" button in **2_1 color-matching** activity.
- Clean up duplicate code introduced in commit `236a1f3` and ensure single source of truth per function.
- addPlayChordButton function implemented and invoked via dynamic import in **2_1_chord_color_matching.js**; Play button should now appear.
- Duplicate color-matching functions removed from `chords.js`; wrappers now dynamically import the module.
- addPlayChordButton now auto-initializes on module load; Play button confirmed in UI.
- Migrated `getMoodLandscapes` to **2_2_chord_mood_landscapes.js** and added dynamic wrapper in `chords.js` (duplicate removed).
- Migrated `updateLandscape` to **2_2_chord_mood_landscapes.js**; wrapper replacement in `chords.js` is now complete.
- Build succeeded after deduplication; user requests similar refactor process for other modules following FILESTRUCTURE.md lines 180-196.
- Bug: `currentChordType` undefined in index.html Play Chord button; need to set/handle variable.
- Note: addPlayChordButton task broken down into subtasks:
  - Implement addPlayChordButton function in **2_1_chord_color_matching.js**.
  - Ensure addPlayChordButton is invoked when activity loads.
  - Verify Play Chord button is visible and clickable.
- Fixed: Fallback approach eliminated; `currentChordType` is now initialized on activity load, ensuring it's always defined before button use.
- After fallback removal, the UI still logs "Unknown chord type: null"—need to trace where `currentChordType` becomes `null` before `playChord` is invoked.
- Redundant audioEngine initialization blocks were stripped; a single, reliable `initAudio` call in `chords.js` now guarantees the engine is ready. Remaining step: verify it fires before any chord playback.
- Identified multiple `currentChordType = null` resets in `chords.js` that may trigger "Unknown chord type: null"; need lifecycle audit.
- [x] Centralize audioEngine initialization in `chords.js` (`initAudio`) and remove scattered checks.
- Removed fallback logic from `playChord`; now logs error and exits when `chordType` is null or unknown, complying with no-fallback rule.
- Unnecessary `currentChordType = null` resets removed in `resetActivity` and post-chord `setTimeout`; lifecycle audit confirms no further null resets remain.
- [x] Optionally add assertion/logging in `playChord` when `chordType` is null to aid debugging.
- `audioEngine` import corrected to use default export; build warning resolved.
- [x] Fix incorrect `audioEngine` import in `chords.js` (use default export or proper named export).
- [x] Fix incorrect `audioEngine` import in `chords.js` (use default export or proper named export).
- [x] Update `addPlayChordButton` in **2_1_chord_color_matching.js** to use the correct `.play-button` selector (scoped to activity container).
- [x] Implement or import `getRandomChordType` (or correct call) inside **2_1_chord_color_matching.js** to prevent runtime error.
- Local `getRandomChordType` helper added in 2_1 module and `newColorMatchingQuestion` updated to use local helpers; runtime error resolved.
- Index menu restructured: locked Chords chapter button implemented and functional referral-code page added beneath Pitches chapter.
- Referral backend (PHP) not yet reachable; need nginx (or web server) configuration and SQLite persistence to track referral clicks & registrations.
- Alpine main component lives in `src/components/app.js`; referral system state & methods must be implemented there (not inline in index.html).
- Referral-view layout enhanced with username registration flow; displays username and referral code after locking.
- `referral.php` endpoint created to generate referral code; **`loadUserData()` now pulls referral data from localStorage. Remaining JS functions (`lockUsername`, `copyReferralCode`, etc.) are now fully implemented and verified.**
- nginx, php-fpm, and php-sqlite3 packages installed; Nginx site config `/etc/nginx/sites-available/lalumo` created and populated.
- `referral.php` extended with SQLite persistence and referral click tracking; frontend awaits testing.
- Build succeeds and Play button logs now appear, but `playChord` is still invoked with `null/undefined` chordType, triggering error; must ensure `newColorMatchingQuestion` sets `currentChordType` before first playback and audit any remaining resets.
- [x] Implement or import `getRandomChordType` (or correct call) inside **2_1_chord_color_matching.js** to prevent runtime error.
- [x] Ensure `newColorMatchingQuestion` assigns `currentChordType` before the first `playChord` invocation and audit any further clears.
- [x] Add locked "Chords" chapter button (with 🔒 icon) beneath Pitches menu section in `index.html`.
- [x] Implement referral-code view/modal (like `playerSettings`) that opens when locked button is clicked.
- [x] Referral system JavaScript implementation
  - [x] Send username to `referral.php` and store returned referral code in localStorage
  - [x] Implement `lockUsername()` to POST username and handle response
  - [x] Implement copyReferralCode() to copy to clipboard with visual feedback
  - [x] Implement shareReferralCode() (native share dialog where available)
  - [x] Implement redeemFriendCode() to validate code and unlock Chords chapter
  - [x] Persist referral progress & unlocked state in localStorage
  - [x] Add new referral-related strings to default strings.xml
  - [x] Create `referral.php` endpoint on server to register username & return referral JSON
  - [x] Load referral data in `loadUserData()`
  - [x] Add POST request from referral-view to `referral.php` and handle response
  - [x] Display fixed username & referral code in referral-view; disable username edits after lock
- [x] Referral system strings added to English `strings-en.xml`; German localization complete.
- [x] Add referral system strings to `strings-de.xml`
- Referral-view HTML structure completed and referral system logic wired into `app.js` (loadUserData extension, saveReferralData, lockUsername, copy/share/redeem code, toast helper).
- Next goal: Fix Tone.js sound playback in **2_1_chords_color-matching**.
- Chords button visibility now toggles via x-show based on `isChordChapterUnlocked`; custom CSS styles for referral code page added.
- [x] Implement referral system logic in `app.js` (state vars & methods)
- [x] Configure nginx / PHP so `referral.php` is accessible from frontend (restart nginx & verify)
- [x] Extend `referral.php` to store usernames in SQLite and track referral counts (link clicks & registrations)
- [x] Create endpoint or logic to register referral link clicks and increment counts
- [ ] Update front-end to fetch and display `referralCount` from backend
- [ ] Perform end-to-end testing of referral workflow and fix issues
- [ ] Restart nginx and verify `referral.php` responds to POST/GET

## Task List
- [x] Decide the correct destination directory for feedback utilities (`src/components/shared/` chosen).
- [x] Create the destination directory.
- [x] Move `src/effects/feedback.js` to the chosen destination.
- [x] Update every import/export statement that references `effects/feedback.js` (one manual fix applied).
- [x] Scan `src/**/*.js` for files stored outside their intended directories per FILESTRUCTURE.md.
- [x] Produce a list of mis-located files and agree on new paths with user if necessary (none found; structure confirmed).
- [x] Relocate the additional mis-placed files and adjust corresponding imports.
- [ ] Update `dev/FILESTRUCTURE.md` sections to reflect the new file locations.
- [ ] Run build/tests to ensure no path errors remain.
- [x] Fix runtime error `checkColorAnswer` undefined in `2_1_chords_color-matching`.
- [ ] Fix Tone.js sound playback in **2_1_chords_color-matching**.
- [x] Fix undefined `currentChordType` reference in index.html Play Chord button.
- [ ] Fix Tone.js sound playback and button responsiveness in **2_2_chords_mood-landscapes**.
- [ ] Debug Play Full Chord button visibility/clickability in **2_3_chords_chord-building** and ensure UI elements fit viewport.
- [ ] Verify sound playback now works in **2_1_chords_color-matching** and **2_2_chords_mood-landscapes** after Tone.js initialization fix.
- [ ] Verify Play Full Chord button is visible and clickable in **2_3_chords_chord-building** after UI adjustments.
- [x] Create external stylesheet `src/styles/2_chords.css` with chord activity styles.
- [x] Ensure `.chord-chapters-view` has fixed height of 800px.
- [x] Link `2_chords.css` stylesheet in app (imported in `chords.js`).
- [x] Remove inline CSS injection from `setupFullHeightContainers` now that external stylesheet is loaded.
- [ ] Fix Tone.js sound playback in **2_4_chords_missing-note**.
- [x] Locate or verify **2_6_chords** module file (created as 2_6_harmmony_garden.js).
- [ ] Fix Tone.js sound playback in **2_6_chords** module.
- [x] Move duplicate functions from `chords.js` into **2_1_chord_color_matching.js** and remove from `chords.js`.
- [ ] Move other activity-specific functions from `chords.js` into their respective `2_chords/*` files and import them.
- [ ] Delete remaining duplicate code blocks caused by commit `236a1f3`.
- [ ] Deduplicate & migrate logic for **2_2_chord_mood_landscapes** into its module.
  - [x] Move getMoodLandscapes to module
  - [x] Remove getMoodLandscapes from `chords.js` and add wrapper with dynamic import
  - [x] Move updateLandscape logic to module
  - [x] Remove updateLandscape from `chords.js` and add wrapper with dynamic import
- [ ] Deduplicate & migrate logic for **2_4_chords_missing-note** into its module.
- [ ] Deduplicate & migrate logic for **2_6_harmmony_garden** into its module.
- [x] Refactor Play Chord button logic to eliminate fallback; initialize first question on activity load so `currentChordType` is always defined.
- [ ] Investigate and fix "Unknown chord type: null" error in color-matching flow (ensure `currentChordType` is never cleared before use).
  - [x] Remove resets at lines 349 and 695 in `chords.js`.
  - [x] Confirmed lines 713 & 724 assign valid chord types (not null) – no change required.
  - [x] Optionally add assertion/logging in `playChord` when `chordType` is null to aid debugging.
  - [ ] Verify `newColorMatchingQuestion` sets `currentChordType` before the first `playChord` call and audit any remaining resets.
- [x] Centralize audioEngine initialization in `chords.js` (`initAudio`) and remove scattered checks.
- [x] Fix incorrect `audioEngine` import in `chords.js` (use default export).
- [x] Fix incorrect `audioEngine` import in `chords.js` (use default export or proper named export).
- [x] Implement lockUsername() to handle username locking and referral code generation.
- [x] Implement dynamic visibility for Chords chapter button based on referral status
- [x] Add referral system strings to `strings-de.xml`
- [x] Implement referral system logic in `app.js` (state vars & methods)

### Chord Chapter Enhancements
- [ ] Review all Chord module files (2_*) and outline necessary changes; ensure function names keep their 2_x abbreviations.
- [x] Ensure all Chord activities trigger rainbow success feedback via `feedback.js`.
  - [x] Import `showCompleteSuccess` (and related helpers) from `src/components/shared/feedback.js` into `src/components/chords.js`.
  - [x] Invoke `showCompleteSuccess` in success handlers for color matching, missing note, character matching, chord building, and harmony gardens.
- [ ] Simplify **2_4_chords_missing-note** activity for younger children.
- [ ] Standardize UI across all Chord activities for consistency.
- [ ] Implement kid-friendly visual feedback for chord playback.
- [x] Implement Tone.js audio and landscape expansion for **2_2_chords_mood-landscapes**.
- [x] Add play-full-chord button in **2_3_chords_chord-building**.
- [ ] Extract piano functionality from Pitches module into shared component and reuse in Chords.
- [ ] Follow `FILESTRUCTURE.md` and `CODING_STANDARDS.md` during implementation.

## Current Goal
- Enable referral backend and logging