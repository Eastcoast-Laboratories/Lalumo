# Referrals System Redesign Plan

## Notes
- User wants to keep a single unlock flag: `areAllActivitiesUnlocked`.
- This flag should unlock three specific activities: "Draw a Melody", "Memory Game" (both in Pitches), and "Chord Story Characters" (in Chords).
- The entire Chords chapter should NOT be unlocked, only these activities.
- UI text in referrals.html and menus must reflect new unlock logic.
- Each of the three activities should have a second, always-unlocked debug button with class `debug-element`.
- Only remove the debug-element main Chords button, not the main Chords chapter button itself; menu should auto-open 2_2 if only one subitem is present.
- Refactor Chords activities: ensure correct lock/unlock logic and debug buttons after menu changes.
- Update referral-related UI strings in both English and German resource files.
- Deployment tested; F-Droid badge image still inaccessible due to double homepage/homepage in URL. Need to fix image path in template or webpack config.
- F-Droid badge image path fixed in template; verified accessible locally and in production.
- User requested to update homepage feature description to mention palm rejection for multitouch.
- F-Droid metadata (com.lalumo.app.yml) is now auto-generated by F-Droid; only license and open source compliance needed in the app itself.
- User requested to add license information to AndroidManifest.xml for F-Droid compliance.
- User requested to generate metadata/com.lalumo.app.yml for F-Droid submission with current version info (3.0, versionCode 26).
- New bug/feature: In 2_5 chord characters, after entering from nav, activity should always start in free mode; first time play is hit, it switches to game mode.
- Cleaning up audio resources on window blur deletes the synth when window loses focus, which is not desired. Only clean up on appropriate lifecycle events (e.g. visibilitychange, beforeunload), not blur.
  - This is already handled: cleanupAudioResources is only called on beforeunload; blur and visibilitychange handlers do not clean up audio.
- New bug/feature: In 2_2 chords stable/instable, after entering from nav, activity should always start in free mode; first time play is hit, it switches to game mode. Play button should reliably switch to game mode, and activity should reset to free mode when re-entered from nav.
- User reports: 2_2_chords_stable_instable progress is always reset to 0 when re-entering from nav. Investigate if progress is stored in localStorage and if it is part of the reset logic.
  - Progress is stored in localStorage and updated in checkStableInstableMatch, but may not be loaded correctly when re-entering activity; likely cause of reset to 0.
  - Progress is now loaded from localStorage on activity entry to prevent reset to 0.
- User requested improved XML minification in webpack config for strings-*.xml: remove leading spaces/tabs.
- User does not want XML files copied to the root directory; only in app/.
- Webpack config for XML minification is being debugged due to syntax error.
- XML minification is now verified to work for all output locations (including public/), with no leading whitespace in lines.
- Progression messages for 2_2_chords_stable_instable (levels 1-6) have been added to HTML and both English and German resource files.
- New feature: In 2_2_chords_stable_instable, when the play button is pressed again, the same chord should repeat until the user gets it right.
  - Feature is now fully implemented: play button repeats the same chord until correct, and Alpine.js feedback variables are properly initialized and updated for correct/incorrect answer feedback.
- BUG: In 2_2_chords_stable_instable, the feedback message (e.g., "Incorrect. It was a stable chord.") is not cleared after a few seconds; needs auto-hide/timeout logic.

## Task List
- [x] Update concept documentation to specify single-flag/multi-activity unlock
- [x] Update referrals.html text to describe new unlock system
- [x] Update menu and activity access logic to use `areAllActivitiesUnlocked` for the three activities
- [x] Add a debug button (class `debug-element`) for each of the three activities, always visible/unlocked
- [x] Test that only the three activities are unlocked by referrals, not the entire Chords chapter
- [x] Test debug buttons for all three activities
- [x] Fix lock/unlock logic and debug buttons for Chords activities
- [x] Update referral UI strings in English and German resource files
- [x] Fix webpack to correctly deploy homepage static images
- [x] Test deployment and homepage image accessibility on production
- [x] Fix F-Droid badge image path (avoid double homepage/) and verify accessibility
- [x] Update homepage feature description to mention palm rejection (multitouch)
- [x] Add license information to AndroidManifest.xml for F-Droid
- [x] Generate metadata/com.lalumo.app.yml for F-Droid submission
- [x] Fix 2_5 chord characters: always start in free mode when entered from nav; switch to game mode on first play
- [x] Move getChordButtons and update2_5ButtonsVisibility to 2_5_chord_characters.js; remove related TODO/import from chords.js
- [x] Refine audio cleanup lifecycle logic to avoid deleting synth on window blur
- [x] Fix 2_2 chords stable/instable: always start in free mode when entered from nav; reliably switch to game mode on play button, and reset to free mode when re-entered from nav
  - [x] Move update2_5ButtonsVisibility to 2_5_chord_characters.js and remove related TODO/import from chords.js
  - [x] Update play button in HTML to call playStableInstableChord($data, false) to reliably start game mode
  - [x] Test that entering from nav always starts in free mode, and play button switches to game mode
  - [x] Ensure progress is loaded from localStorage and not reset to 0 when re-entering activity
  - [x] Refactor 2_2_chords_stable_instable background logic to use dynamic images based on progress
- [x] Update webpack config to minify XML files (remove leading whitespace)
  - [x] Ensure minification applies to all output locations including public/
- [x] Add progression messages for 2_2_chords_stable_instable to HTML and resource files
  - [x] Add English and German strings for levels 1-6 (CONCEPT.md#L162-168)
  - [x] Insert correct message binding in index.html at lines 794-799
  - [x] Test correct display and translation of progression messages
- [x] Update 2_2 chords stable/instable: Play button should repeat the same chord until the user gets it right
  - [x] Define and initialize Alpine.js feedback variables (showStableInstableFeedback, stableInstableFeedback) in chords component
  - [x] Fix Alpine.js feedback variable errors for correct/incorrect answer feedback
- [x] Fix: Auto-hide feedback message after a few seconds in 2_2_chords_stable_instable

## Current Goal
No outstanding urgent tasks