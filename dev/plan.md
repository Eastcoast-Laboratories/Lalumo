# Musici File Structure Alignment Plan

## Notes
- User identified /src/effects/feedback.js as being in the wrong place.
- Reference canonical structure in dev/FILESTRUCTURE.md, shared utilities should live under `src/components/shared/`.
- The directory `src/components/shared/` has been created to house shared utilities.
- `feedback.js` relocated to `src/components/shared/`.
- Manual review revealed and fixed one import referencing the old path.
- Must also look for any other JS files that violate the documented structure and relocate them.
- After relocating, all import paths across the codebase must be updated.
- Update dev/FILESTRUCTURE.md to match the new, real structure.
- Adhere to user global rules: no fallback code, no unnecessary deployment, add diagnostics if needed.
- User confirmed file structure is correct; focus shifts to enhancing Chord Chapter user experience.
- User requested to review Chord code first and keep 2_x abbreviations in function names.
- Main Chords entry file is `src/components/chords.js`; sub-modules `2_*` will be migrated later.
- Rainbow feedback integrated into `chords.js` across all chord activities.
- Runtime error `checkColorAnswer is not defined` observed in `chords.js`; must fix.
- `checkColorAnswer` now imported into chords.js, error resolved.
- Tone.js audio and richer landscapes integrated into 2_2 mood landscapes.
- Play-full-chord button implemented in 2_3 chord-building.
- Audio-engine singleton (`src/components/audio-engine.js`) now powers all chord sounds; initAudio simply ensures `audioEngine.initialize()` is called upon first user gesture.
- User reports no sound in 2_1 and 2_2, and missing/unresponsive Play Full Chord button in 2_3; suspect off-screen buttons—set containers to 100% viewport height and debug Tone.js initialization / Transport start.
- Initial fixes committed: forced Tone.start() in initAudio, added full-height CSS for activity containers, and improved Play Full Chord button container lookup; awaiting user verification.
- `setupFullHeightContainers` function has been implemented to enforce 100vh containers and style rules.
- Replaced require usage in setupFullHeightContainers to avoid bundler issues; enhanced Tone.js auto-start logic and fixed Play Full Chord button positioning.
- User requested moving injected CSS rules into external stylesheet `src/styles/2_chords.css` and setting `.chord-chapters-view` height to 800px.
- Created external stylesheet `src/styles/2_chords.css` including chord activity styles and `.chord-chapters-view` height rule.
- Stylesheet now imported in `chords.js`, and inline CSS injection removed from `setupFullHeightContainers`.
- Injected existing `audioEngine` & Tone import into **2_1_chord_color_matching**, **2_2_chords_mood-landscapes**, **2_4_chords_missing-note**, and **2_6_harmmony_garden** to enable sound; awaiting verification.
- `2_6_harmmony_garden.js` module has been created and initial audio imports added.
- User explicitly said not to add a new audio engine; must reuse existing AudioEngine implementation already powering other chapters.
- User identified duplicate functions (e.g., `newColorMatchingQuestion`, `checkColorAnswer`) existing both in `chords.js` and `2_x` module files; wants duplicates removed and logic housed only in the respective `2_chords/*` files.
- `chords.js` should act as orchestrator/importer; all activity-specific logic must live inside `src/components/2_chords/` modules.
- Need a visible "Play Chord" button in **2_1 color-matching** activity.
- Clean up duplicate code introduced in commit `236a1f3` and ensure single source of truth per function.
- addPlayChordButton function implemented and invoked via dynamic import in **2_1_chord_color_matching.js**; Play button should now appear.
- Duplicate color-matching functions removed from `chords.js`; wrappers now dynamically import the module.
- addPlayChordButton now auto-initializes on module load; Play button confirmed in UI.
- Migrated `getMoodLandscapes` to **2_2_chord_mood_landscapes.js** and added dynamic wrapper in `chords.js` (duplicate removed).
- Migrated `updateLandscape` to **2_2_chord_mood_landscapes.js**; wrapper replacement in `chords.js` is now complete.
- Build succeeded after deduplication; user requests similar refactor process for other modules following FILESTRUCTURE.md lines 180-196.
- Bug: `currentChordType` undefined in index.html Play Chord button; need to set/handle variable.
- Note: addPlayChordButton task broken down into subtasks:
  - Implement addPlayChordButton function in **2_1_chord_color_matching.js**.
  - Ensure addPlayChordButton is invoked when activity loads.
  - Verify Play Chord button is visible and clickable.
- Fixed: Fallback approach eliminated; `currentChordType` is now initialized on activity load, ensuring it's always defined before button use.
- After fallback removal, the UI still logs "Unknown chord type: null"—need to trace where `currentChordType` becomes `null` before `playChord` is invoked.
- Redundant audioEngine initialization blocks were stripped; a single, reliable `initAudio` call in `chords.js` now guarantees the engine is ready. Remaining step: verify it fires before any chord playback.
- Identified multiple `currentChordType = null` resets in `chords.js` that may trigger "Unknown chord type: null"; need lifecycle audit.
- [x] Centralize audioEngine initialization in `chords.js` (`initAudio`) and remove scattered checks.
- Removed fallback logic from `playChord`; now logs error and exits when `chordType` is null or unknown, complying with no-fallback rule.
- Unnecessary `currentChordType = null` resets removed in `resetActivity` and post-chord `setTimeout`; lifecycle audit confirms no further null resets remain.
- [x] Optionally add assertion/logging in `playChord` when `chordType` is null to aid debugging.
- `audioEngine` import corrected to use default export; build warning resolved.
- [x] Fix incorrect `audioEngine` import in `chords.js` (use default export).
- [x] Fix incorrect `audioEngine` import in `chords.js` (use default export or proper named export).
- [x] Update `addPlayChordButton` in **2_1_chord_color_matching.js** to use the correct `.play-button` selector (scoped to activity container).
- [x] Implement or import `getRandomChordType` (or correct call) inside **2_1_chord_color_matching.js** to prevent runtime error.
- Local `getRandomChordType` helper added in 2_1 module and `newColorMatchingQuestion` updated to use local helpers; runtime error resolved.
- Index menu restructured: locked Chords chapter button implemented and functional referral-code page added beneath Pitches chapter.
- Referral backend (PHP) now fully functional; nginx (or web server) configuration and SQLite persistence implemented to track referral clicks & registrations.
- Alpine main component lives in `src/components/app.js`; referral system state & methods must be implemented there (not inline in index.html).
- Referral-view layout enhanced with username registration flow; displays username and referral code after locking.
- `referral.php` extended with SQLite persistence and click tracking; backend endpoint now fully functional (needs frontend integration & testing).
- Frontend `app.js` now points to `http://localhost:8080/referral.php`; `lockUsername`, new `fetchReferralCount`, and updated `redeemFriendCode` integrate with the backend and persist counts in state.
- Referral-view page now displays registration and click statistics and unlock state; UI complete.
- Referral-view UI enhanced with detailed registration/click stats and unlocked-status indicator; ready for e2e testing.
- [x] Hamburger menu now auto-closes on referral view activation (index.html updated).
- [x] Simple password-protected admin dashboard `admin.php` lists registered users and referral stats.
- Note: New user requirements include persisting registration state in localStorage and fetching referral counts on page load.
- Implemented localStorage persistence (including referralClickCount) and auto-fetch of referral stats on app load.
- Note: User requested automated end-to-end testing using Playwright with a 10 s timeout to avoid page hangs.
- Implement tests for admin dashboard accessibility via http://localhost:9091/admin.php.
- Playwright end-to-end and admin dashboard unit tests implemented; ready to run.
- [x] Add Playwright end-to-end tests for referral workflow (registration, click tracking, redeem, unlock) with 10 s timeout.
- [x] Add unit test (Node) for admin dashboard endpoint (`admin.php`).
- Admin dashboard GET request returns login page (HTTP 200), but POST authentication with password currently returns HTTP 500 – needs debugging.
- Initial investigation indicates the 500 stems from SQLite DB init: missing `data/` directory and unhandled exceptions in `admin.php`.
- Admin dashboard authentication fixed: data directory ensured and improved SQLite error handling; POST now returns 200 OK.
- Admin dashboard JSON API verified via wget; returns correct statistics payload.
- Playwright referral-system tests initiated (awaiting results).
- User requests hero logo image (logo_bird_sings.jpg) be shown as a circular background icon without border on homepage.
- Hero logo now styled via CSS as circular background icon without border; img tag removed.
- User asked if logo image can be gitignored; need to update .gitignore accordingly.
- logo path added to .gitignore.
- Admin dashboard shows no data after registration; need to confirm SQLite insert and refresh logic.
- Admin dashboard shows no data after registration; need to confirm SQLite insert and refresh logic.
- Observed `/data` directory exists but `referrals.db` not created; registration POST may not trigger DB creation/insert. Debug `referral.php` registration flow and ensure DB/tables/rows are created.
- Nginx logs revealed permission errors (`/var/www/Musici/data` not writable); directory permissions fixed via `sudo chmod`, retest registration flow.
- SQLite database `referrals.db` now created after registration attempt; still shows no users, indicating insert logic or admin query needs debugging.
- Manual registration via curl (`testuser123`) succeeded; user inserted and referral code returned, confirming `referral.php` insert logic works.
- Admin dashboard JSON still returns empty user list; likely SQL query or refresh issue in `admin.php` requiring debugging.
- Root cause: `admin.php` uses non-existent columns (`referrer_code`, `referral_type`) in its SQL; query must join `users` and `referrals` on `referrer_id` and select `click_count`, `registration_count`.
- Admin dashboard SQL query updated to join `users` and `referrals`; however JSON API still returns empty list—need to verify DB path/data and table join logic.
- Verified `users` table contains registration (e.g., testuser123), but `referrals` table lacks corresponding row; LEFT JOIN still yields NULL counts yet API returns empty—investigate query filtering and ensure referral row insertion.
- Admin dashboard SQL query updated to aggregate counts by `referral_type`; JSON API now correctly lists registered users and statistics.
- Android icon assets available in `dev/IconKitchen-Output/web/`; use for favicons.
- Icon files copied to `src/` and `src/icons/`; favicon links added to `src/index.html`.
- Icon files copied to `src/` and `src/icons/`; favicon links added to `src/index.html`.
- Favicon links added to `homepage/index.html` and `favicon.ico` copied to project root; favicon setup complete.
- 404 for `/favicon.ico` in webpack dev server resolved by copying `favicon.ico` to `public/` directory; curl now returns 200.
- User requested enhanced frontend feedback for username registration: spinner on button while awaiting response, visual success (show password) or error messages, and a hint indicating the username will be locked.
- User requested enhanced frontend feedback for username registration: spinner on button while awaiting response, visual success (show password) or error messages, and a hint indicating the username will be locked.
- Registration UI feedback (spinner, success/error messages, password display) integrated into index.html; `isRegistering` bound and explanatory text added.
- - `copyToClipboard` function in app.js generalized (including improved fallback) to copy arbitrary text, enabling password copy.
- - Missing registration feedback strings (`registration_success`, `registration_error`, `username_exists`) added to `strings-de.xml`.
- Ensure `admin.php` queries correctly fetch user data from SQLite DB
- [x] Ensure `admin.php` queries correctly fetch user data from SQLite DB
- Investigate why updated query still returns zero rows (check DB contents & paths)
- [x] Investigate why updated query still returns zero rows (check DB contents & paths)
- Verify admin JSON API lists newly registered users after change
- [x] Verify admin JSON API lists newly registered users after change
- Adjust `admin.php` queries if schema mismatch
- [x] Adjust `admin.php` queries if schema mismatch
- Re-test admin dashboard after registration
- [x] Re-test admin dashboard after registration
- Add Android icon as favicon to app index page and homepage
  - [x] Copy favicon and icon PNGs to `src/` and `src/icons/`
  - [x] Insert <link rel="icon"> tags in `src/index.html`
  - [x] Insert <link rel="icon"> tags in `homepage/index.html`
  - [x] Copy `favicon.ico` to `public/` for dev server
- Clean up `dev/Concept_Referral-System.md`: remove completed items and document current referral data flow, DB schema, code interactions
- `dev/Concept_Referral-System.md` has been rewritten with current referral system documentation.
- [x] Clean up `dev/Concept_Referral-System.md`: remove completed items and document current referral data flow, DB schema, code interactions
- lockUsername UI feedback (spinner, success/error messages, password display) variables added in `app.js`; implementation incomplete and introduced syntax errors to be fixed.
- [ ] Fix syntax errors in `app.js` stemming from `lockUsername()` refactor and ensure build passes
- [ ] Consolidate duplicate `lockUsername()` implementations into one version (with spinner, success/error handling, password display)
- [x] Bind `isRegistering` to UI: show spinner & disable Register button during request
- [x] Add missing strings (`registration_success`, `registration_error`, `username_exists`) to `strings-de.xml`
- [x] Add explanatory text before Register button about username locking
- [x] Generalize `copyToClipboard` to accept arbitrary text & use for password copying

## Task List
- [x] Decide the correct destination directory for feedback utilities (`src/components/shared/` chosen).
- [x] Create the destination directory.
- [x] Move `src/effects/feedback.js` to the chosen destination.
- [x] Update every import/export statement that references `effects/feedback.js` (one manual fix applied).
- [x] Scan `src/**/*.js` for files stored outside their intended directories per FILESTRUCTURE.md.
- [x] Produce a list of mis-located files and agree on new paths with user if necessary (none found; structure confirmed).
- [x] Relocate the additional mis-placed files and adjust corresponding imports.
- [ ] Update `dev/FILESTRUCTURE.md` sections to reflect the new file locations.
- [ ] Run build/tests to ensure no path errors remain.
- [x] Fix runtime error `checkColorAnswer` undefined in `2_1_chords_color-matching`.
- [ ] Fix Tone.js sound playback in **2_1_chords_color-matching**.
- [x] Fix undefined `currentChordType` reference in index.html Play Chord button.
- [ ] Fix Tone.js sound playback and button responsiveness in **2_2_chords_mood-landscapes**.
- [ ] Debug Play Full Chord button visibility/clickability in **2_3_chords_chord-building** and ensure UI elements fit viewport.
- [ ] Verify sound playback now works in **2_1_chords_color-matching** and **2_2_chords_mood-landscapes** after Tone.js initialization fix.
- [ ] Verify Play Full Chord button is visible and clickable in **2_3_chords_chord-building** after UI adjustments.
- [x] Create external stylesheet `src/styles/2_chords.css` with chord activity styles.
- [x] Ensure `.chord-chapters-view` has fixed height of 800px.
- [x] Link `2_chords.css` stylesheet in app (imported in `chords.js`).
- [x] Remove inline CSS injection from `setupFullHeightContainers` now that external stylesheet is loaded.
- [ ] Fix Tone.js sound playback in **2_4_chords_missing-note**.
- [x] Locate or verify **2_6_chords** module file (created as 2_6_harmmony_garden.js).
- [ ] Fix Tone.js sound playback in **2_6_chords** module.
- [x] Move duplicate functions from `chords.js` into **2_1_chord_color_matching.js** and remove from `chords.js`.
- [ ] Move other activity-specific functions from `chords.js` into their respective `2_chords/*` files and import them.
- [ ] Delete remaining duplicate code blocks caused by commit `236a1f3`.
- [ ] Deduplicate & migrate logic for **2_2_chord_mood_landscapes** into its module.
  - [x] Move getMoodLandscapes to module
  - [x] Remove getMoodLandscapes from `chords.js` and add wrapper with dynamic import
  - [x] Move updateLandscape logic to module
  - [x] Remove updateLandscape from `chords.js` and add wrapper with dynamic import
- [ ] Deduplicate & migrate logic for **2_4_chords_missing-note** into its module.
- [ ] Deduplicate & migrate logic for **2_6_harmmony_garden** into its module.
- [x] Refactor Play Chord button logic to eliminate fallback; initialize first question on activity load so `currentChordType` is always defined.
- [ ] Investigate and fix "Unknown chord type: null" error in color-matching flow (ensure `currentChordType` is never cleared before use).
  - [x] Remove resets at lines 349 and 695 in `chords.js`.
  - [x] Confirmed lines 713 & 724 assign valid chord types (not null) – no change required.
  - [x] Optionally add assertion/logging in `playChord` when `chordType` is null to aid debugging.
  - [ ] Verify `newColorMatchingQuestion` sets `currentChordType` before the first `playChord` call and audit any remaining resets.
- [x] Centralize audioEngine initialization in `chords.js` (`initAudio`) and remove scattered checks.
- [x] Fix incorrect `audioEngine` import in `chords.js` (use default export).
- [x] Fix incorrect `audioEngine` import in `chords.js` (use default export or proper named export).
- [x] Implement lockUsername() to handle username locking and referral code generation.
- [x] Implement dynamic visibility for Chords chapter button based on referral status
- [x] Add referral system strings to `strings-de.xml`
- [x] Implement referral system logic in `app.js` (state vars & methods)
- [x] Persist registration state (`isUsernameLocked`) and referral data in localStorage (verify implementation)
- [x] Fetch referral statistics on page load when user is registered (call `fetchReferralCount()` in `loadUserData`)
- [x] Persist registration state (`isUsernameLocked`) and referral data in localStorage (verify implementation)
- [x] Fetch referral statistics on page load when user is registered (call `fetchReferralCount()` in `loadUserData`)
- [x] Add Playwright end-to-end tests for referral workflow (registration, click tracking, redeem, unlock) with 10 s timeout.
- [x] Add unit test (Node) for admin dashboard endpoint (`admin.php`).
- [x] Confirm admin dashboard accessible via wget/fetch http://localhost:9091/admin.php.
- [x] Fix HTTP 500 error on admin dashboard authentication (POST to admin.php).
- [ ] Perform end-to-end testing of referral workflow and fix issues
- [x] Style hero logo (images/logo_bird_sings.jpg) as round background icon without border in homepage.
- [x] Add logo image path to .gitignore (confirm with user).
- [ ] Investigate missing admin data: verify SQLite DB entry on registration and fix.
- [x] Ensure `referral.php` username registration inserts into `users` & `referrals` tables
- [x] Confirm `referrals.db` file is created after first registration
- [x] Ensure `admin.php` queries correctly fetch user data from SQLite DB
  - [x] Fix data directory permissions so PHP can create SQLite DB
  - [x] Rewrite `getUserStats` SQL to join `users` and `referrals` on `referrer_id` and fetch `click_count`, `registration_count`
  - [x] Investigate why updated query still returns zero rows (check DB contents & paths)
  - [x] Verify `users` table has data but join returns none (referrals row missing)
  - [x] Fix `referrals` table schema (add `referrer_id`, `click_count`, `registration_count`) or align code to current schema
  - [x] Ensure `referral.php` always inserts a row into `referrals` for new users (after schema fix)
  - [x] Backfill `referrals` table for existing users (migration script or SQL)
  - [x] Modify admin query to use `COALESCE(r.click_count,0)` etc. to include users even if no referral row
  - [x] Verify admin JSON API lists newly registered users after change
  - [ ] Update admin dashboard table rendering to use new fields
  - [x] Verify admin JSON API lists newly registered users after change
  - [ ] Adjust `admin.php` queries if schema mismatch
- [x] Re-test admin dashboard after registration
- [x] Re-test admin dashboard after registration
- [x] Add Android icon as favicon to app index page and homepage
  - [x] Copy favicon and icon PNGs to `src/` and `src/icons/`
  - [x] Insert <link rel="icon"> tags in `src/index.html`
  - [x] Insert <link rel="icon"> tags in `homepage/index.html`
  - [x] Copy `favicon.ico` to `public/` for dev server
- [ ] Update `referral.php` to reject duplicate usernames and generate password
- [ ] Extend `lockUsername()` flow to show spinner, disable button, and display success (password) or detailed error messages
- [x] Add explanatory text before Register button about username locking
- [x] Clean up `dev/Concept_Referral-System.md`: remove completed items and document current referral data flow, DB schema, code interactions

## Current Goal
- Implement username existence check & password generation in referral.php
- Add UI spinner and feedback for username registration
- Fix lockUsername syntax errors & finish registration UI feedback