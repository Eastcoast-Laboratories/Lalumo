# Musici File Structure Alignment Plan

## Notes
- User identified /src/effects/feedback.js as being in the wrong place.
- Reference canonical structure in dev/FILESTRUCTURE.md, shared utilities should live under `src/components/shared/`.
- The directory `src/components/shared/` has been created to house shared utilities.
- `feedback.js` relocated to `src/components/shared/`.
- Manual review revealed and fixed one import referencing the old path.
- Must also look for any other JS files that violate the documented structure and relocate them.
- After relocating, all import paths across the codebase must be updated.
- Update dev/FILESTRUCTURE.md to match the new, real structure.
- Adhere to user global rules: no fallback code, no unnecessary deployment, add diagnostics if needed.
- Git checkout/reset commands are disallowed; repair files manually.
- User confirmed file structure is correct; focus shifts to enhancing Chord Chapter user experience.
- User requested to review Chord code first and keep 2_x abbreviations in function names.
- Main Chords entry file is `src/components/chords.js`; sub-modules `2_*` will be migrated later.
- Rainbow feedback integrated into `chords.js` across all chord activities.
- Runtime error `checkColorAnswer is not defined` observed in `chords.js`; must fix.
- `checkColorAnswer` now imported into chords.js, error resolved.
- Tone.js audio and richer landscapes integrated into 2_2 mood landscapes.
- Play-full-chord button implemented in 2_3 chord-building.
- Audio-engine singleton (`src/components/audio-engine.js`) now powers all chord sounds; initAudio simply ensures `audioEngine.initialize()` is called upon first user gesture.
- User reports no sound in 2_1 and 2_2, and missing/unresponsive Play Full Chord button in 2_3; suspect off-screen buttons—set containers to 100% viewport height and debug Tone.js initialization / Transport start.
- Initial fixes committed: forced Tone.start() in initAudio, added full-height CSS for activity containers, and improved Play Full Chord button container lookup; awaiting user verification.
- `setupFullHeightContainers` function has been implemented to enforce 100vh containers and style rules.
- Replaced require usage in setupFullHeightContainers to avoid bundler issues; enhanced Tone.js auto-start logic and fixed Play Full Chord button positioning.
- User requested moving injected CSS rules into external stylesheet `src/styles/2_chords.css` and setting `.chord-chapters-view` height to 800px.
- Created external stylesheet `src/styles/2_chords.css` including chord activity styles and `.chord-chapters-view` height rule.
- Stylesheet now imported in `chords.js`, and inline CSS injection removed from `setupFullHeightContainers`.
- Initial background image for 2_5 chord characters added in index.html activity container.
- `updateCharacterBackground` function implemented and wired into `chords.js` (init & after correct answer); progress now persisted in `lalumo_chords_progress` (localStorage).
- User requested extracting `update_progress_display` helper from pitches.js into a shared `common.js` for reuse.
- `updateCharacterBackground` function implemented and wired into `chords.js` (init & after correct answer); progress now persisted in `lalumo_chords_progress` (localStorage).
- User requested extracting `update_progress_display` helper from pitches.js into a shared `common.js` for reuse.
- Discovery: two separate common.js files already exist (`src/components/pitches/common.js` and `src/components/2_chords/common.js`); need unified location for shared UI helpers.
- New shared helper module `src/components/shared/ui-helpers.js` created containing `update_progress_display`; imported into `pitches.js`.
- Shared UI helper now also imported in `chords.js` and used in 2_5 character activity to update progress display.
- Runtime bug: `$store is not defined` when `update_progress_display` executes inside `chords.js` (Alpine context missing). Must refactor call to avoid direct `$store` reference (use component or Alpine.store()).
- Need to remove legacy `update_progress_display` method from `pitches.js` and redirect all calls to shared helper.
- Runtime bug `$store is not defined` in 2_5 progress display has been fixed by constructing strings via `this.$store` before passing to helper.
- New UI issue: progress display shows duplicate "Correct answers" lines and no unlock hint. Must ensure single element and dynamic hint ("Get 10 correct ...", "Get 20 correct ...") renders correctly.
- Removed redundant JS progress display in 2_5; Alpine bindings now show correct count and unlock hints.
- `debug-element` CSS class added to `main.css` to hide debug buttons by default; visibility toggled via `body.dev-mode`.
- Inline `style="opacity: 0;"` attributes auto-replaced with `class="debug-element"` in index.html via sed.
- Frontend protection added: users cannot redeem their own referral code (redeemFriendCode now checks against `referralCode`).
- Backend PHP now blocks self-redeem attempts when the username is supplied; frontend must include `username` in the redeem request.
- Duplicate `redeemFriendCode` functions detected in `src/components/app.js` (lines ~291 and ~1953); older version must be removed to prevent conflicting logic.
- Duplicate `redeemFriendCode` functions issue resolved: older version replaced with stub comment; only enhanced version remains.
- Index menu restructured: locked Chords chapter button implemented and functional referral-code page added beneath Pitches chapter.
- Referral backend (PHP) now fully functional; nginx (or web server) configuration and SQLite persistence implemented to track referral clicks & registrations.
- Alpine main component lives in `src/components/app.js`; referral system state & methods must be implemented there (not inline in index.html).
- Referral-view layout enhanced with username registration flow; displays username and referral code after locking.
- `referral.php` extended with SQLite persistence and click tracking; backend endpoint now fully functional (needs frontend integration & testing).
- Frontend `app.js` now points to `http://localhost:8080/referral.php`; `lockUsername`, new `fetchReferralCount`, and updated `redeemFriendCode` integrate with the backend and persist counts in state.
- Referral-view page now displays registration and click statistics and unlock state; UI complete.
- Referral-view UI enhanced with detailed registration/click stats and unlocked-status indicator; ready for e2e testing.
- [x] Hamburger menu now auto-closes on referral view activation (index.html updated).
- [x] Simple password-protected admin dashboard `admin.php` lists registered users and referral stats.
- Note: New user requirements include persisting registration state in localStorage and fetching referral counts on page load.
- Implemented localStorage persistence (including referralClickCount) and auto-fetch of referral stats on app load.
- Note: User requested automated end-to-end testing using Playwright with a 10 s timeout to avoid page hangs.
- Implement tests for admin dashboard accessibility via http://localhost:9091/admin.php.
- Playwright end-to-end and admin dashboard unit tests implemented; ready to run.
- [x] Add Playwright end-to-end tests for referral workflow (registration, click tracking, redeem, unlock) with 10 s timeout.
- [x] Add unit test (Node) for admin dashboard endpoint (`admin.php`).
- Admin dashboard GET request returns login page (HTTP 200), but POST authentication with password currently returns HTTP 500 – needs debugging.
- Initial investigation indicates the 500 stems from SQLite DB init: missing `data/` directory and unhandled exceptions in `admin.php`.
- Admin dashboard authentication fixed: data directory ensured and improved SQLite error handling; POST now returns 200 OK.
- Admin dashboard JSON API verified via wget; returns correct statistics payload.
- Playwright referral-system tests initiated (awaiting results).
- User requested hero logo image (logo_bird_sings.jpg) be shown as a circular background icon without border on homepage.
- Hero logo now styled via CSS as circular background icon without border; img tag removed.
- User asked if logo image can be gitignored; need to update .gitignore accordingly.
- logo path added to .gitignore.
- Admin dashboard shows no data after registration; need to confirm SQLite insert and refresh logic.
- Admin dashboard shows no data after registration; need to confirm SQLite insert and refresh logic.
- Observed `/data` directory exists but `referrals.db` not created; registration POST may not trigger DB creation/insert. Debug `referral.php` registration flow and ensure DB/tables/rows are created.
- Nginx logs revealed permission errors (`/var/www/Musici/data` not writable); directory permissions fixed via `sudo chmod`, retest registration flow.
- SQLite database `referrals.db` now created after registration attempt; still shows no users, indicating insert logic or admin query needs debugging.
- Manual registration via curl (`testuser123`) succeeded; user inserted and referral code returned, confirming `referral.php` insert logic works.
- Admin dashboard JSON still returns empty user list; likely SQL query or refresh issue in `admin.php` requiring debugging.
- Root cause: `admin.php` uses non-existent columns (`referrer_code`, `referral_type`) in its SQL; query must join `users` and `referrals` on `referrer_id` and select `click_count`, `registration_count`.
- Admin dashboard SQL query updated to join `users` and `referrals`; however JSON API still returns empty list—need to verify DB path/data and table join logic.
- Verified `users` table contains registration (e.g., testuser123), but `referrals` table lacks corresponding row; LEFT JOIN still yields NULL counts yet API returns empty—investigate query filtering and ensure referral row insertion.
- Admin dashboard SQL query updated to aggregate counts by `referral_type`; JSON API now correctly lists registered users and statistics.
- Android icon assets available in `dev/IconKitchen-Output/web/`; use for favicons.
- Icon files copied to `src/` and `src/icons/`; favicon links added to `src/index.html`.
- Icon files copied to `src/` and `src/icons/`; favicon links added to `src/index.html`.
- Favicon links added to `homepage/index.html` and `favicon.ico` copied to project root; favicon setup complete.
- 404 for `/favicon.ico` in webpack dev server resolved by copying `favicon.ico` to `public/` directory; curl now returns 200.
- User requested enhanced frontend feedback for username registration: spinner on button while awaiting response, visual success (show password) or error messages, and a hint indicating the username will be locked.
- User requested enhanced frontend feedback for username registration: spinner on button while awaiting response, visual success (show password) or error messages, and a hint indicating the username will be locked.
- Registration UI feedback (spinner, success/error messages, password display) integrated into index.html; `isRegistering` bound and explanatory text added.
- Reset section in settings partial restructured; reset buttons correctly embedded and partial copied to `public/partials/`; awaiting UI verification.
- `copyToClipboard` function in app.js generalized (including improved fallback) to copy arbitrary text, enabling password copy.
- Missing registration feedback strings (`registration_success`, `registration_error`, `username_exists`) added to `strings-de.xml`.
- Ensure `admin.php` queries correctly fetch user data from SQLite DB
- [x] Ensure `admin.php` queries correctly fetch user data from SQLite DB
- Investigate why updated query still returns zero rows (check DB contents & paths)
- [x] Investigate why updated query still returns zero rows (check DB contents & paths)
- Verify admin JSON API lists newly registered users after change
- [x] Verify admin JSON API lists newly registered users after change
- Adjust `admin.php` queries if schema mismatch
- [x] Adjust `admin.php` queries if schema mismatch
- Re-test admin dashboard after registration
- [x] Re-test admin dashboard after registration
- Add Android icon as favicon to app index page and homepage
  - [x] Copy favicon and icon PNGs to `src/` and `src/icons/`
  - [x] Insert <link rel="icon"> tags in `src/index.html`
  - [x] Insert <link rel="icon"> tags in `homepage/index.html`
  - [x] Copy `favicon.ico` to `public/` for dev server
- Clean up `dev/Concept_Referral-System.md`: remove completed items and document current referral data flow, DB schema, code interactions
- Concept doc now lists new TODOs: duplicate-username check, automatic password generation, richer UI feedback, admin user deletion, and deploy sync requirements
- Duplicate username check and automatic password generation implemented in referral.php; POST returns password and 409 on duplicates.
- [x] Update `referral.php` to reject duplicate usernames and generate password
- [x] Clean up `dev/Concept_Referral-System.md`: remove completed items and document current referral data flow, DB schema, code interactions
- Legacy `lockUsername()` implementation removed; consolidated version starting at line ~1757 remains and includes UI feedback logic. Need final cleanup & build fix.
- Initial removal of the first (legacy) `lockUsername()` implementation done; still need to clean up leftover comment and verify single definitive version compiles.
- Legacy `lockUsername()` implementation removed; consolidated version starting at line ~1757 remains and includes UI feedback logic.
- API URL updated to http://localhost:8080/referral.php and header comment clarified.
- API URL updated to http://localhost:8080/referral.php and header comment clarified.
- Build now passes after lockUsername refactor.
- Frontend registration fetch fails due to CORS (duplicate/missing Access-Control-Allow-Origin header); need to fix server headers.
- Duplicate CORS headers removed from `referral.php`; Nginx now exclusively sets CORS headers.
- [x] Fix CORS headers for referral.php (single Access-Control-Allow-Origin)
- [x] Fix `referral.php` GET endpoint for `username` stats to return correct JSON and avoid HTTP 500
- Backend: Improved `referral.php` GET handler for `username` to avoid 500 errors, auto-create referral rows when missing.
- Encountering `403 Forbidden` when accessing `http://localhost:8080`; likely Nginx root/permissions issue—must resolve to test UI. Temporarily started PHP dev server on http://127.0.0.1:8000 for testing; need permanent fix.
- [ ] Verify UI feedback works, registration succeeds, password displayed and stats fetched after fixes
- [ ] Test frontend via http://127.0.0.1:8000 with PHP dev server and run registration flow
- [ ] Fix 403 Forbidden on `http://localhost:8080` so the frontend is accessible for testing (Nginx root / permissions)
- [ ] Update `fetchReferralCount()` to parse updated payload and robustly handle errors
- [ ] Perform end-to-end testing of referral workflow and fix issues
- [x] Style hero logo (images/logo_bird_sings.jpg) as round background icon without border in homepage.
- [x] Add logo image path to .gitignore (confirm with user).
- [ ] Investigate missing admin data: verify SQLite DB entry on registration and fix.
- [x] Ensure `referral.php` username registration inserts into `users` & `referrals` tables
- [x] Confirm `referrals.db` file is created after first registration
- [x] Ensure `admin.php` queries correctly fetch user data from SQLite DB
  - [x] Fix data directory permissions so PHP can create SQLite DB
  - [x] Rewrite `getUserStats` SQL to join `users` and `referrals` on `referrer_id` and fetch `click_count`, `registration_count`
  - [x] Investigate why updated query still returns zero rows (check DB contents & paths)
  - [x] Verify `users` table has data but join returns none (referrals row missing)
  - [x] Fix `referrals` table schema (add `referrer_id`, `click_count`, `registration_count`) or align code to current schema
  - [x] Ensure `referral.php` always inserts a row into `referrals` for new users (after schema fix)
  - [x] Backfill `referrals` table for existing users (migration script or SQL)
  - [x] Modify admin query to use `COALESCE(r.click_count,0)` etc. to include users even if no referral row
  - [x] Verify admin JSON API lists newly registered users after change
  - [ ] Update admin dashboard table rendering to use new fields
  - [x] Verify admin JSON API lists newly registered users after change
  - [ ] Adjust `admin.php` queries if schema mismatch
- [x] Re-test admin dashboard after registration
- [x] Re-test admin dashboard after registration
- [x] Add Android icon as favicon to app index page and homepage
  - [x] Copy favicon and icon PNGs to `src/` and `src/icons/`
  - [x] Insert <link rel="icon"> tags in `src/index.html`
  - [x] Insert <link rel="icon"> tags in `homepage/index.html`
  - [x] Copy `favicon.ico` to `public/` for dev server
- [x] Update `referral.php` to reject duplicate usernames and generate password
- [ ] Extend `lockUsername()` flow to show spinner, disable button, and display success (password) or detailed error messages
- [x] Add explanatory text before Register button about username locking
- [ ] Clean up `dev/Concept_Referral-System.md`: remove completed items and document current referral data flow, DB schema, code interactions
- [ ] Implement delete-user functionality in admin dashboard
- [ ] Ensure `deploy.sh` syncs PHP files and initializes SQLite DB on production server
- User requested limiting consecutive identical pitch patterns to a maximum of three; requires update in `pitches.js` pattern selection logic.
- Initial implementation committed but introduced extensive syntax/lint errors in `pitches.js`; needs cleanup and verification.
- [x] Update `referral.php` to reject duplicate usernames and generate password
- [ ] Limit consecutive pattern repetitions to max 3 in `pitches.js` matching mode
  - [ ] Fix syntax/lint errors introduced in `pitches.js` and finalize pattern limit logic
  - [x] Remove duplicated second `data()` block (lines ~2849-2893)
  - [ ] Remove any remaining duplicate `methods` block / stray code and ensure build passes
- Referral section being extracted to partial `src/partials/referrals.html`; `html-loader` dev dependency installed to enable inclusion via webpack.
- Need to update `webpack.config.js` with `html-loader` rule and adjust `index.html` to load partial.
- [x] Modularize referral code page using html-loader
  - [x] Create `src/partials/referrals.html` with referral section content
  - [x] Add `html-loader` rule in `webpack.config.js`
  - [x] Replace referral section in `src/index.html` with `<div data-include="./partials/referrals.html"></div>` or appropriate require syntax
  - [x] Verify build & runtime functionality without regressions
- Note: Updated webpack.config.js with html-loader rule and index.html now includes referral partial.
- Build currently fails: html-loader not processing referrals.html (Module parse failed). Need to adjust loader rule/import and restore successful build.
- Note: Updated webpack.config.js with html-loader rule and index.html now includes referral partial.
- Added `utils/html-include.js` with `loadHtmlPartials()` utility; imported in `index.js` to dynamically render HTML partials.
- Build currently fails: html-loader not processing referrals.html (Module parse failed). Need to adjust loader rule/import and restore successful build.
- [x] Fix html-loader rule so partial HTML files are correctly processed (adjust include/exclude pattern)
- [x] Update or remove import statement in `index.js` to match loader expectations
- [ ] Verify build & runtime functionality without regressions (build currently failing)
- [x] Fix html-loader rule so partial HTML files are correctly processed (adjust include/exclude pattern)
- [x] Update or remove import statement in `index.js` to match loader expectations
- [x] Call `loadHtmlPartials()` after Alpine initialization to render partials
- [ ] Validate runtime functionality of referral partial loading and resolve any server port conflicts
- html-loader build error resolved with `esModule: false`; build now succeeds.
- Introduced `utils/html-include.js` and `loadHtmlPartials()` runs post-Alpine to inject referral partial at runtime.
- Runtime in browser shows `HTML partial loading error` (fetch 404 for ./partials/referrals.html); need to adjust dev server path or include utility logic.
- Path handling updated in html-include.js and index.html to use absolute `/src/partials/referrals.html`; awaiting verification.
- [x] Call `loadHtmlPartials()` after Alpine initialization to render partials
- [ ] Validate runtime functionality of referral partial loading and resolve any server port conflicts
- [ ] Fix fetch path / dev server config so `/src/partials/referrals.html` loads successfully
- [x] Fix fetch path / dev server config so `/src/partials/referrals.html` loads successfully
- [x] Fix fetch path / dev server config so `/src/partials/referrals.html` loads successfully
- Runtime in browser showed `HTML partial loading error` (404). Partial copied to `public/partials/referrals.html` so dev server can serve it.
- Need to update `index.html` data-include path to `/partials/referrals.html` and verify loading succeeds.
- [x] Copy `referrals.html` to `public/partials/` for dev server access
- [x] Update `index.html` data-include to `/partials/referrals.html`
- [x] Verify referral partial loads without 404 and renders correctly
- [x] Verify referral partial loads without 404; test runtime
- [x] Extract Impress page into `partials/impress.html` and include via data-include
- [x] Extract Credits page into `partials/credits.html` and include via data-include
- [x] Extract Settings page into `partials/settings.html` and include via data-include
- Impress partial (`src/partials/impress.html`) created; next copy to public and hook up.
- Runtime referral partial confirmed working via `/partials/referrals.html`.
- Next: modularize remaining pages (Impress, Credits, Settings) similarly.
- Ensure copied to `public/partials/` and paths updated.
- [x] Update index.html to include Impress, Credits, Settings partials via data-include
  - [x] Update index.html to include Impress partial via data-include
  - [x] Update index.html to include Credits partial via data-include
  - [x] Update index.html to include Settings partial via data-include
  - [x] Verify Impress, Credits, Settings partials load without 404 and render correctly
- Runtime referral partial confirmed working via `/partials/referrals.html`.
- Impress, Credits, and Settings partial HTML files created under `src/partials/` and copied to `public/partials/`.
- `index.html` updated to include Impress and Credits via data-include elements; Settings include still pending.
- [x] Extract Impress page into `partials/impress.html` and include via data-include
- [x] Extract Credits page into `partials/credits.html` and include via data-include
- [x] Extract Settings page into `partials/settings.html` and include via data-include
- [x] Copy `impress.html` to `public/partials/` and update path in index
- [x] Copy `credits.html` to `public/partials/` and update path in index
- [x] Copy `settings.html` to `public/partials/` and update path in index
- [x] Verify Impress, Credits, Settings partials load without 404 and render correctly
- [x] Copy `settings.html` to `public/partials/` and update path in index
- [x] Update index.html to include Settings partial via data-include
- [x] Verify Impress, Credits, Settings partials load without 404 and render correctly
- Note: Reset section in settings partial restructured; reset buttons correctly embedded and partial copied to `public/partials/`; awaiting UI verification.
- Existing file `src/components/pitches/1_2_match_sounds.js` already contains some helper logic.
- New directory `src/components/1_pitches/` created to hold pitch activity modules; need to consolidate location.
- New directory `src/components/1_pitches/` was created by mistake; per FILESTRUCTURE.md, activity modules stay under `src/components/pitches/`. Must consolidate to a single canonical path and remove duplicates.
- New directory `src/components/1_pitches/` was created by mistake; per FILESTRUCTURE.md, activity modules must remain in `src/components/pitches/`. Consolidation required.
- Duplicate directory `src/components/1_pitches/` has been removed.
- Migration of 1_2_match_sounds functions to separate module was reverted; related tasks cancelled.
- [x] Delete duplicate `src/components/1_pitches/1_2_match_sounds.js`
- [x] Update imports in `pitches.js` to use canonical path
- [x] Update `pitches.js` to import and delegate to new module (remove duplicates)
- [ ] Run build & verify 1_2 activity functionality
- [ ] Fix SyntaxError in `pitches.js` (line ~1297) and any related issues
- [ ] Re-run build & confirm no errors
- [ ] Manually inspect `pitches.js` for additional brace/comma mismatches introduced by automated replacements and correct them
- [ ] Once build passes, test 1_2_match_sounds activity end-to-end
- Runtime Alpine error: `component.stopCurrentSound is not a function` discovered in 1_2 activity; calling undefined method.
- Earlier attempt to inline call caused massive syntax errors; must revert and instead export `stopCurrentSound` from pitches.js and import in 1_2 module.
- Approach: add named export `stopCurrentSound` in pitches.js (no structural rewrite), alias in component (`this.stopCurrentSound` already exists), and import `{ stopCurrentSound }` into 1_2_match_sounds.js; call directly.
- [ ] Fix `stopCurrentSound` undefined runtime error (expose/export function and import in 1_2 module)
  - [ ] Revert erroneous inline replacement in pitches.js
  - [ ] Add `export function stopCurrentSound(component)` helper encapsulating existing logic
  - [ ] Ensure pitches.js references this helper; keep method intact
  - [ ] Import and use `stopCurrentSound` directly in 1_2_match_sounds.js instead of `component.stopCurrentSound()`
  - [ ] Run build & verify 1_2 activity functionality
  - [ ] Retest 1_2_match_sounds activity end-to-end after fix
- [ ] Fix `stopCurrentSound` undefined runtime error (expose/export function and import in 1_2 module)
- [ ] Fix `stopCurrentSound` undefined runtime error (expose/export function and import in 1_2 module)
- Chords progress tracking system implemented in `chords.js`, mirroring the logic from `pitches.js`; per-activity counts now persist in `lalumo_chords_progress`.
- `checkColorAnswer` now increments `totalQuestions` and writes progress after each answer.
- Color grid in index.html currently passes `$store` to `checkColorAnswer`, causing `currentChordType` to be undefined – need to pass the chords component (`$data`) instead.
- Color grid click handlers updated to use `$data`; answers now recognized.
- Scope bug in `playChord` fixed (outer `chord` variable); ReferenceError resolved.
- [x] Fix color grid click handlers in index.html to pass chords component to `checkColorAnswer`.
  - [ ] Verify rainbow / error feedback effects and audio playback trigger correctly after fix.
  - Note: Fixing this bug revealed a new issue with audio playback not working as expected.
- [ ] Fix audio playback issue in color-matching activity.
- New issue: `ReferenceError: chord is not defined` inside `playChord`; likely variable scope bug preventing audio playback.
- [x] Fix `ReferenceError: chord is not defined` in `playChord` and ensure sound plays.
  - [ ] Verify audio playback works after fix.
- New runtime error: `audioEngine.playChord is not a function`; need chord playback method in AudioEngine or adjust call in chords.js.
- [ ] Fix audio playback issue in color-matching activity.
  - [ ] Implement `playChord` method in `audio-engine.js` (poly-synth plays multiple notes) or refactor `chords.js` to use existing API
  - [ ] Verify chord audio playback in 2_1 and 2_2 after fix
- New runtime error resolved: `playChord` method implemented in AudioEngine; need sound verification.
- Requested enhancement: `debugLog` should accept an array of tags and prepend them.
- [x] Implement `playChord` method in `audio-engine.js` (poly-synth plays multiple notes) or refactor `chords.js` to use existing API
- [ ] Verify chord audio playback in 2_1 and 2_2 after fix
- [x] Update `debugLog` utility to accept array of tags
- debugLog utility now accepts array of tags.
- Naming conflict detected: two playChord functions (chords.js vs audio-engine.js); must resolve.
- playChord function in chords.js renamed to playChordByType; internal and 2_1 module references updated.
- [ ] Update all references to component.playChord to playChordByType in 2_chords modules and chords.js wrappers
  - [ ] Replace playChord calls in 2_1_chord_color_matching.js
  - [x] Replace playChord calls in 2_2_chord_mood_landscapes.js
  - [ ] Remove/adjust guards that check typeof component.playChord
  - [ ] Run build & verify no missing method errors
- [ ] Run build & verify chord audio playback in 2_1 and 2_2 after refactor
- [x] Resolve playChord naming conflict between chords.js and audio-engine.js (renamed to playChordByType)
- [ ] Update all references to component.playChord to playChordByType in 2_chords modules and chords.js wrappers
  - [x] Replace playChord calls in 2_1_chord_color_matching.js
  - [ ] Replace playChord calls in 2_2_chord_mood_landscapes.js
  - [x] Remove/adjust guards that check typeof component.playChord
  - [ ] Run build & verify no missing method errors
- [ ] Run build & verify chord audio playback in 2_1 and 2_2 after refactor
- User requested dynamic background progression for 2_5 chord characters based on correct answer milestones (0, 10, 20) with specific images.
- [x] Remove/adjust guards that check typeof component.playChord
- [x] Replace playChord calls in 2_1_chord_color_matching.js
- [x] Remove/adjust guards that check typeof component.playChord
- [ ] Run build & verify chord audio playback in 2_1 and 2_2 after refactor
- # New tasks for 2_5 chord character activity
- [x] Update index.html 2_5 activity container to use initial background image `/public/images/backgrounds/2_5_chords_dog_cat_owl_no_squirrel_no_octopus.png`.
- [ ] Implement progress-based background updates for 2_5 chord characters:
  - [x] Add `updateCharacterBackground()` (similar to pitches.updateMatchingBackground).
  - [x] Change background to *_squirrel_no_octopus at 10 correct answers.
  - [x] Change background to *_squirrel_octopus at 20 correct answers.
  - [x] Store & read progress in `lalumo_chords_progress`.
  - [x] Wire `updateCharacterBackground` call in `chords.js` on init & after correct answer.
  - [ ] Verify visuals during gameplay.
- `updateCharacterBackground` helper implemented in `2_5_chord_characters.js` to switch backgrounds at 0/10/20 correct answers.
- `updateCharacterBackground` now imported into `chords.js`; wiring to events pending.
- [ ] Implement progress-based background updates for 2_5 chord characters:
  - [x] Add `updateCharacterBackground()` (similar to pitches.updateMatchingBackground).
  - [x] Change background to *_squirrel_no_octopus at 10 correct answers.
  - [x] Change background to *_squirrel_octopus at 20 correct answers.
  - [x] Store & read progress in `lalumo_chords_progress`.
  - [x] Wire `updateCharacterBackground` call in `chords.js` on init & after correct answer.
  - [ ] Verify visuals during gameplay.
- Note: Wiring updateCharacterBackground and storing progress in lalumo_chords_progress is now complete.
- Progress display added to **2_5** activity in index.html showing correct count and unlock hints.
- [x] Verify visuals during gameplay.
- User requested using the shared `update_progress_display` in 2_5 character activity.
- [x] Remove local `update_progress_display` method from pitches.js and update calls to use shared helper
- [x] Ensure build passes after refactor
- [x] Integrate shared `update_progress_display` into 2_5 character activity (update index/chords logic)
## Current Goal
- [x] Fix `$store` undefined error in 2_5 progress display
- [x] Deduplicate progress display in 2_5 activity and inject unlock-hint text (10/20 thresholds)
- [x] Add configurable CSS class to hide debug buttons (opacity 0) with toggle for local development
## Current Goal
- Implement CSS class for hiding debug buttons
- Note: Added debug-element CSS class to hide debug buttons by default; visibility toggled via body.dev-mode.
- [x] Add `.debug-element` class to main.css with opacity control and `body.dev-mode` override
- [x] Replace inline `style="opacity: 0;"` on debug buttons with `class="debug-element"`
- [x] Document/enable dev-mode body class toggle for local development
- [x] Add configurable CSS class to hide debug buttons (opacity 0) with toggle for local development
- [ ] Display shareable referral link with click count in UI
## Current Goal
- Implement backend self-redeem protection & share link display
- Note: Frontend self-redeem protection implemented; users cannot redeem their own referral code.
- [x] Prevent users from redeeming their own referral code (backend & frontend)
- [x] Display shareable referral link with click count in UI
- Note: Referral link feature partially implemented; need to fix syntax errors and complete UI.
- [ ] Fix syntax errors in referral link feature
- [ ] Complete referral link UI and display click count
- [ ] Verify referral link feature works as expected
## Current Goal
- Implement backend self-redeem protection & share link display
Referral link generation & copy functionality added to app.js; link now shown in referral UI.
- [x] Fix syntax errors in referral link feature
- [ ] Complete referral link UI and display click count
- [ ] Verify referral link feature works as expected
Referral link feature implemented; link generation, UI and click count display integrated; awaiting verification.
- [x] Complete referral link UI and display click count
## Current Goal
Update Concept doc & verify referral link UI
Finalize Concept doc & complete self-redeem integration
- [x] Verify referral link feature works as expected
- [x] Update `redeemFriendCode()` to include `username` in the POST payload
- [x] Handle 403 response and show UI error when user tries to redeem own code
- [x] Add e2e test to confirm self-redeem is blocked
- [x] Remove duplicate `redeemFriendCode` function (old version at ~291) from `app.js`
-   - [x] Keep enhanced version (~1953) with dashed code validation pattern
-   - [ ] Run build & referral e2e tests to confirm no regressions
- Remove duplicate redeemFriendCode and verify build/tests pass